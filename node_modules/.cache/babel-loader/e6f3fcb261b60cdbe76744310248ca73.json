{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.receiveAPDU = void 0;\nvar _errors = require(\"@ledgerhq/errors\");\nvar _rxjs = require(\"rxjs\");\nvar _logs = require(\"@ledgerhq/logs\");\nconst TagId = 0x05; // operator that transform the input raw stream into one apdu response and finishes\n\nconst receiveAPDU = rawStream => _rxjs.Observable.create(o => {\n  let notifiedIndex = 0;\n  let notifiedDataLength = 0;\n  let notifiedData = Buffer.alloc(0);\n  const sub = rawStream.subscribe({\n    complete: () => {\n      o.error(new _errors.DisconnectedDevice());\n      sub.unsubscribe();\n    },\n    error: e => {\n      (0, _logs.log)(\"ble-error\", \"in receiveAPDU \" + String(e));\n      o.error(e);\n      sub.unsubscribe();\n    },\n    next: value => {\n      const tag = value.readUInt8(0);\n      const index = value.readUInt16BE(1);\n      let data = value.slice(3);\n      if (tag !== TagId) {\n        o.error(new _errors.TransportError(\"Invalid tag \" + tag.toString(16), \"InvalidTag\"));\n        return;\n      }\n      if (notifiedIndex !== index) {\n        o.error(new _errors.TransportError(\"BLE: Invalid sequence number. discontinued chunk. Received \" + index + \" but expected \" + notifiedIndex, \"InvalidSequence\"));\n        return;\n      }\n      if (index === 0) {\n        notifiedDataLength = data.readUInt16BE(0);\n        data = data.slice(2);\n      }\n      notifiedIndex++;\n      notifiedData = Buffer.concat([notifiedData, data]);\n      if (notifiedData.length > notifiedDataLength) {\n        o.error(new _errors.TransportError(\"BLE: received too much data. discontinued chunk. Received \" + notifiedData.length + \" but expected \" + notifiedDataLength, \"BLETooMuchData\"));\n        return;\n      }\n      if (notifiedData.length === notifiedDataLength) {\n        o.next(notifiedData);\n        o.complete();\n        sub.unsubscribe();\n      }\n    }\n  });\n  return () => {\n    sub.unsubscribe();\n  };\n});\nexports.receiveAPDU = receiveAPDU;","map":{"version":3,"sources":["../../src/ble/receiveAPDU.js"],"names":["TagId","receiveAPDU","rawStream","create","o","notifiedIndex","notifiedDataLength","notifiedData","Buffer","alloc","sub","subscribe","complete","error","DisconnectedDevice","unsubscribe","e","String","next","value","tag","readUInt8","index","readUInt16BE","data","slice","TransportError","toString","concat","length"],"mappings":";;;;;;AAEA,IAAA,OAAA,GAAA,OAAA,CAAA,kBAAA,CAAA;AACA,IAAA,KAAA,GAAA,OAAA,CAAA,MAAA,CAAA;AACA,IAAA,KAAA,GAAA,OAAA,CAAA,gBAAA,CAAA;AAEA,MAAMA,KAAK,GAAG,IAAd,C,CAEA;;AACO,MAAMC,WAAW,GACtBC,SADyB,IAGzB,KAAA,CAAA,UAAA,CAAWC,MAAX,CAAmBC,CAAD,IAAO;EACvB,IAAIC,aAAa,GAAG,CAApB;EACA,IAAIC,kBAAkB,GAAG,CAAzB;EACA,IAAIC,YAAY,GAAGC,MAAM,CAACC,KAAPD,CAAa,CAAbA,CAAnB;EAEA,MAAME,GAAG,GAAG,SAAS,CAACC,SAAV,CAAoB;IAC9BC,QAAQ,EAAE,MAAM;MACdR,CAAC,CAACS,KAAFT,CAAQ,IAAIU,OAAAA,CAAAA,kBAAJ,EAARV,CAAAA;MACAM,GAAG,CAACK,WAAJL,EAAAA;IACD,CAJ6B;IAK9BG,KAAK,EAAGG,CAAD,IAAO;MACZ,CAAA,CAAA,EAAA,KAAA,CAAA,GAAA,EAAI,WAAJ,EAAiB,iBAAA,GAAoBC,MAAM,CAACD,CAAD,CAA3C,CAAA;MACAZ,CAAC,CAACS,KAAFT,CAAQY,CAARZ,CAAAA;MACAM,GAAG,CAACK,WAAJL,EAAAA;IACD,CAT6B;IAU9BQ,IAAI,EAAGC,KAAD,IAAW;MACf,MAAMC,GAAG,GAAGD,KAAK,CAACE,SAANF,CAAgB,CAAhBA,CAAZ;MACA,MAAMG,KAAK,GAAGH,KAAK,CAACI,YAANJ,CAAmB,CAAnBA,CAAd;MACA,IAAIK,IAAI,GAAGL,KAAK,CAACM,KAANN,CAAY,CAAZA,CAAX;MAEA,IAAIC,GAAG,KAAKpB,KAAZ,EAAmB;QACjBI,CAAC,CAACS,KAAFT,CACE,IAAIsB,OAAAA,CAAAA,cAAJ,CAAmB,cAAA,GAAiBN,GAAG,CAACO,QAAJP,CAAa,EAAbA,CAApC,EAAsD,YAAtD,CADFhB,CAAAA;QAGA;MACD;MAED,IAAIC,aAAa,KAAKiB,KAAtB,EAA6B;QAC3BlB,CAAC,CAACS,KAAFT,CACE,IAAIsB,OAAAA,CAAAA,cAAJ,CACE,6DAAA,GACEJ,KADF,GAEE,gBAFF,GAGEjB,aAJJ,EAKE,iBALF,CADFD,CAAAA;QASA;MACD;MAED,IAAIkB,KAAK,KAAK,CAAd,EAAiB;QACfhB,kBAAkB,GAAGkB,IAAI,CAACD,YAALC,CAAkB,CAAlBA,CAArBlB;QACAkB,IAAI,GAAGA,IAAI,CAACC,KAALD,CAAW,CAAXA,CAAPA;MACD;MACDnB,aAAa,EAAA;MACbE,YAAY,GAAGC,MAAM,CAACoB,MAAPpB,CAAc,CAACD,YAAD,EAAeiB,IAAf,CAAdhB,CAAfD;MACA,IAAIA,YAAY,CAACsB,MAAbtB,GAAsBD,kBAA1B,EAA8C;QAC5CF,CAAC,CAACS,KAAFT,CACE,IAAIsB,OAAAA,CAAAA,cAAJ,CACE,4DAAA,GACEnB,YAAY,CAACsB,MADf,GAEE,gBAFF,GAGEvB,kBAJJ,EAKE,gBALF,CADFF,CAAAA;QASA;MACD;MACD,IAAIG,YAAY,CAACsB,MAAbtB,KAAwBD,kBAA5B,EAAgD;QAC9CF,CAAC,CAACc,IAAFd,CAAOG,YAAPH,CAAAA;QACAA,CAAC,CAACQ,QAAFR,EAAAA;QACAM,GAAG,CAACK,WAAJL,EAAAA;MACD;IACF;EA1D6B,CAApB,CAAZ;EA6DA,OAAO,MAAM;IACXA,GAAG,CAACK,WAAJL,EAAAA;EACD,CAFD;AAGD,CArED,CAHK","sourcesContent":["// @flow\n\nimport { TransportError, DisconnectedDevice } from \"@ledgerhq/errors\";\nimport { Observable } from \"rxjs\";\nimport { log } from \"@ledgerhq/logs\";\n\nconst TagId = 0x05;\n\n// operator that transform the input raw stream into one apdu response and finishes\nexport const receiveAPDU = (\n  rawStream: Observable<Buffer>\n): Observable<Buffer> =>\n  Observable.create((o) => {\n    let notifiedIndex = 0;\n    let notifiedDataLength = 0;\n    let notifiedData = Buffer.alloc(0);\n\n    const sub = rawStream.subscribe({\n      complete: () => {\n        o.error(new DisconnectedDevice());\n        sub.unsubscribe();\n      },\n      error: (e) => {\n        log(\"ble-error\", \"in receiveAPDU \" + String(e));\n        o.error(e);\n        sub.unsubscribe();\n      },\n      next: (value) => {\n        const tag = value.readUInt8(0);\n        const index = value.readUInt16BE(1);\n        let data = value.slice(3);\n\n        if (tag !== TagId) {\n          o.error(\n            new TransportError(\"Invalid tag \" + tag.toString(16), \"InvalidTag\")\n          );\n          return;\n        }\n\n        if (notifiedIndex !== index) {\n          o.error(\n            new TransportError(\n              \"BLE: Invalid sequence number. discontinued chunk. Received \" +\n                index +\n                \" but expected \" +\n                notifiedIndex,\n              \"InvalidSequence\"\n            )\n          );\n          return;\n        }\n\n        if (index === 0) {\n          notifiedDataLength = data.readUInt16BE(0);\n          data = data.slice(2);\n        }\n        notifiedIndex++;\n        notifiedData = Buffer.concat([notifiedData, data]);\n        if (notifiedData.length > notifiedDataLength) {\n          o.error(\n            new TransportError(\n              \"BLE: received too much data. discontinued chunk. Received \" +\n                notifiedData.length +\n                \" but expected \" +\n                notifiedDataLength,\n              \"BLETooMuchData\"\n            )\n          );\n          return;\n        }\n        if (notifiedData.length === notifiedDataLength) {\n          o.next(notifiedData);\n          o.complete();\n          sub.unsubscribe();\n        }\n      },\n    });\n\n    return () => {\n      sub.unsubscribe();\n    };\n  });\n"]},"metadata":{},"sourceType":"script"}